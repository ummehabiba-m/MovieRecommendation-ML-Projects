name: ML Engineering CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily training at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.10'
  DOCKER_IMAGE: movielens-mlops

jobs:
  # Job 1: Code Quality & Linting
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort pylint
    
    - name: Run Black formatter check
      run: |
        black --check src/ tests/ || echo "Black formatting issues found"
    
    - name: Run isort check
      run: |
        isort --check-only src/ tests/ || echo "Import sorting issues found"
    
    - name: Run Flake8
      run: |
        flake8 src/ tests/ --max-line-length=120 --ignore=E501,W503 || echo "Flake8 issues found"

  # Job 2: Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: |
        pytest tests/test_data_pipeline.py -v --tb=short --cov=src --cov-report=xml --cov-report=html
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # Job 3: ML Tests with DeepChecks
  ml-validation:
    name: ML Validation Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run ML validation tests
      run: |
        pytest tests/test_ml_validation.py -v --tb=short
    
    - name: Upload test reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ml-test-reports
        path: |
          models/data_integrity_report.html
          models/model_evaluation_report.html

  # Job 4: Data Validation
  data-validation:
    name: Data Validation
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download and validate data
      run: |
        python -c "
        from src.data_loader import MovieLensDataLoader
        loader = MovieLensDataLoader()
        ratings, movies, users = loader.load_all_data()
        print(f'✓ Data validation passed: {len(ratings)} ratings loaded')
        assert len(ratings) > 90000, 'Insufficient data'
        assert ratings['rating'].between(1, 5).all(), 'Invalid ratings found'
        "

  # Job 5: Model Training
  model-training:
    name: Train ML Models
    runs-on: ubuntu-latest
    needs: [ml-validation, data-validation]
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run training pipeline
      run: |
        python src/prefect_flows.py
      env:
        HOPSWORKS_API_KEY: ${{ secrets.HOPSWORKS_API_KEY }}
        MLFLOW_TRACKING_URI: http://localhost:5000
    
    - name: Upload trained models
      uses: actions/upload-artifact@v3
      with:
        name: trained-models
        path: models/
        retention-days: 30

  # Job 6: Build Docker Image
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: model-training
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest
          ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ github.sha }}
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:buildcache,mode=max

  # Job 7: Deploy to Production
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://your-app-url.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to server
      run: |
        echo "Deploying to production..."
        # Add your deployment commands here
        # For example: SSH into server, pull latest image, restart containers
        
    - name: Health check
      run: |
        echo "Running health check..."
        # curl -f http://your-server/health || exit 1
    
    - name: Send notification
      if: always()
      run: |
        echo "Deployment completed"
        # Add Discord/Slack notification here

  # Job 8: Monitor Data Drift
  data-drift-monitoring:
    name: Data Drift Monitoring
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Check for data drift
      run: |
        python -c "
        print('Running data drift detection...')
        # Add data drift detection logic here
        # Using Evidently or custom drift detection
        "
    
    - name: Alert on drift detected
      if: failure()
      run: |
        echo "⚠️ Data drift detected! Please investigate."
        # Send alert to Discord/Slack
